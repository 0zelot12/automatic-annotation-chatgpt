import numpy as np

from pet.pet_dataset import PetDataset

from entity.entity import Entity

from relation.relation import parse_relations


mock_api_response = "ACTIVITY,$7,$7,ACTOR_PERFORMER,ACTOR,$4,$4\nACTIVITY,$7,$7,USES,ACTIVITY_DATA,$5,$5\nACTIVITY,$7,$7,FLOW,ACTIVITY,$13,$13\nACTIVITY,$13,$13,USES,ACTIVITY_DATA,$18,$20\nACTIVITY,$13,$13,FLOW,ACTIVITY,$23,$23\nACTIVITY,$23,$23,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$23,$23,USES,ACTIVITY_DATA,$21,$21\nACTIVITY,$23,$23,FLOW,ACTIVITY,$34,$34\nACTIVITY,$34,$34,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$34,$34,USES,ACTIVITY_DATA,$36,$37\nACTIVITY,$34,$34,FLOW,XOR_GATEWAY,$48,$48\nXOR_GATEWAY,$48,$48,FLOW,CONDITION_SPECIFICATION,$49,$53\nCONDITION_SPECIFICATION,$49,$53,FLOW,ACTIVITY,$55,$60\nACTIVITY,$55,$60,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$55,$60,USES,ACTIVITY_DATA,$18,$20\nACTIVITY,$55,$60,FLOW,ACTIVITY,$61,$61\nACTIVITY,$61,$61,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$61,$61,USES,ACTIVITY_DATA,$33,$33\nACTIVITY,$61,$61,FLOW,ACTIVITY,$65,$65\nACTIVITY,$65,$65,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$65,$65,USES,ACTIVITY_DATA,$63,$64\nACTIVITY,$65,$65,FLOW,XOR_GATEWAY,$72,$72\nXOR_GATEWAY,$72,$72,FLOW,CONDITION_SPECIFICATION,$73,$79\nCONDITION_SPECIFICATION,$73,$79,FLOW,ACTIVITY,$84,$84\nACTIVITY,$84,$84,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$84,$84,USES,ACTIVITY_DATA,$75,$77\nACTIVITY,$84,$84,FLOW,ACTIVITY,$81,$81\nACTIVITY,$81,$81,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$81,$81,USES,ACTIVITY_DATA,$73,$74\nACTIVITY,$81,$81,FLOW,ACTIVITY,$88,$88\nACTIVITY,$88,$88,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$88,$88,USES,ACTIVITY_DATA,$86,$87\nACTIVITY,$88,$88,FLOW,XOR_GATEWAY,$96,$96\nXOR_GATEWAY,$96,$96,FLOW,CONDITION_SPECIFICATION,$97,$103\nCONDITION_SPECIFICATION,$97,$103,FLOW,ACTIVITY,$107,$110\nACTIVITY,$107,$110,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$107,$110,USES,ACTIVITY_DATA,$105,$108\nACTIVITY,$107,$110,FLOW,ACTIVITY,$121,$121\nACTIVITY,$121,$121,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$121,$121,USES,ACTIVITY_DATA,$117,$119\nACTIVITY,$121,$121,FLOW,ACTIVITY,$134,$134\nACTIVITY,$134,$134,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$134,$134,USES,ACTIVITY_DATA,$126,$130\nACTIVITY,$134,$134,FLOW,ACTIVITY,$142,$142\nACTIVITY,$142,$142,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$142,$142,USES,ACTIVITY_DATA,$144,$147\nACTIVITY,$142,$142,FLOW,XOR_GATEWAY,$149,$149\nXOR_GATEWAY,$149,$149,FLOW,CONDITION_SPECIFICATION,$150,$153\nCONDITION_SPECIFICATION,$150,$153,FLOW,ACTIVITY,$154,$154\nACTIVITY,$154,$154,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$154,$154,USES,ACTIVITY_DATA,$156,$160\nACTIVITY,$154,$154,FLOW,ACTIVITY,$167,$167\nACTIVITY,$167,$167,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$167,$167,USES,ACTIVITY_DATA,$163,$165\nACTIVITY,$167,$167,FLOW,XOR_GATEWAY,$167,$167\nXOR_GATEWAY,$167,$167,FLOW,CONDITION_SPECIFICATION,$168,$171\nCONDITION_SPECIFICATION,$168,$171,FLOW,ACTIVITY,$176,$176\nACTIVITY,$176,$176,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$176,$176,USES,ACTIVITY_DATA,$174,$175\nACTIVITY,$176,$176,FLOW,ACTIVITY,$183,$183\nACTIVITY,$183,$183,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$183,$183,USES,ACTIVITY_DATA,$181,$182\nACTIVITY,$183,$183,FLOW,ACTIVITY,$196,$196\nACTIVITY,$196,$196,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$196,$196,USES,ACTIVITY_DATA,$194,$195\nACTIVITY,$196,$196,FLOW,ACTIVITY,$203,$203\nACTIVITY,$203,$203,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$203,$203,USES,ACTIVITY_DATA,$201,$202\nACTIVITY,$203,$203,FLOW,ACTIVITY,$213,$213\nACTIVITY,$213,$213,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$213,$213,USES,ACTIVITY_DATA,$211,$212\nACTIVITY,$213,$213,FLOW,ACTIVITY,$221,$221\nACTIVITY,$221,$221,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$221,$221,USES,ACTIVITY_DATA,$218,$220\nACTIVITY,$221,$221,FLOW,ACTIVITY,$224,$224\nACTIVITY,$224,$224,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$224,$224,USES,ACTIVITY_DATA,$223,$224\nACTIVITY,$224,$224,FLOW,ACTIVITY,$232,$232\nACTIVITY,$232,$232,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$232,$232,USES,ACTIVITY_DATA,$229,$231\nACTIVITY,$232,$232,FLOW,ACTIVITY,$254,$254\nACTIVITY,$254,$254,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$254,$254,USES,ACTIVITY_DATA,$252,$253\nACTIVITY,$254,$254,FLOW,ACTIVITY,$261,$261\nACTIVITY,$261,$261,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$261,$261,USES,ACTIVITY_DATA,$259,$260\nACTIVITY,$261,$261,FLOW,ACTIVITY,$268,$268\nACTIVITY,$268,$268,USES,ACTIVITY_DATA,$266,$267\nACTIVITY,$268,$268,FLOW,ACTIVITY,$276,$276\nACTIVITY,$276,$276,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$276,$276,USES,ACTIVITY_DATA,$274,$275\nACTIVITY,$276,$276,FLOW,ACTIVITY,$284,$284\nACTIVITY,$284,$284,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$284,$284,USES,ACTIVITY_DATA,$282,$283\nACTIVITY,$284,$284,FLOW,XOR_GATEWAY,$290,$290\nXOR_GATEWAY,$290,$290,FLOW,CONDITION_SPECIFICATION,$291,$355\nCONDITION_SPECIFICATION,$291,$355,FLOW,ACTIVITY,$358,$358\nACTIVITY,$358,$358,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$358,$358,USES,ACTIVITY_DATA,$356,$357\nACTIVITY,$358,$358,FLOW,ACTIVITY,$372,$372\nACTIVITY,$372,$372,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$372,$372,USES,ACTIVITY_DATA,$370,$371\nACTIVITY,$372,$372,FLOW,ACTIVITY,$395,$395\nACTIVITY,$395,$395,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$395,$395,USES,ACTIVITY_DATA,$393,$394\nACTIVITY,$395,$395,FLOW,ACTIVITY,$400,$400\nACTIVITY,$400,$400,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$400,$400,USES,ACTIVITY_DATA,$397,$399\nACTIVITY,$400,$400,FLOW,ACTIVITY,$420,$420\nACTIVITY,$420,$420,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$420,$420,USES,ACTIVITY_DATA,$418,$418\nACTIVITY,$420,$420,ACTOR_RECIPIENT,ACTOR,$419,$419\nACTIVITY,$420,$420,FLOW,XOR_GATEWAY,$462,$466\nXOR_GATEWAY,$462,$466,FLOW,CONDITION_SPECIFICATION,$467,$471\nXOR_GATEWAY,$462,$466,FLOW,ACTIVITY,$476,$476\nCONDITION_SPECIFICATION,$467,$471,FLOW,ACTIVITY,$478,$478\nACTIVITY,$478,$478,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$478,$478,USES,ACTIVITY_DATA,$479,$493\nACTIVITY,$478,$478,FLOW,ACTIVITY,$497,$497\nACTIVITY,$497,$497,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$497,$497,USES,ACTIVITY_DATA,$495,$496\nACTIVITY,$497,$497,FLOW,ACTIVITY,$509,$509\nACTIVITY,$509,$509,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$509,$509,USES,ACTIVITY_DATA,$507,$508\nACTIVITY,$509,$509,FLOW,ACTIVITY,$514,$514\nACTIVITY,$514,$514,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$514,$514,ACTOR_RECIPIENT,ACTOR,$511,$513\nACTIVITY,$514,$514,FLOW,ACTIVITY,$522,$522\nACTIVITY,$522,$522,ACTOR_PERFORMER,ACTOR,$18,$20\nACTIVITY,$522,$522,USES,ACTIVITY_DATA,$517,$521"

dataset = PetDataset()

documents = dataset.get_all_documents()
documents = [d.name for d in documents]


test_document = dataset.get_document_by_name("doc-9.1")

recognized_relations = parse_relations(
    mock_api_response.splitlines(), test_document.tokens
)

recognized_entities: list[Entity] = []
for relation in recognized_relations:
    recognized_entities.extend([relation.source, relation.target])
recognized_entities = list(set(recognized_entities))

for gold_entity in test_document.entities:
    index_range_gold = gold_entity.get_index_range()
    for entity in recognized_entities:
        index_range = entity.get_index_range()
        intersection = np.intersect1d(index_range, index_range_gold)
        if entity.type == gold_entity.type and len(intersection) > 1:
            print(f"MATCH: {index_range} <-> {index_range_gold}")
